{% extends "base.html" %}
{% block content %}
<div class="app-container">
    <header class="hero" style="padding-bottom: 20px;">
        <div class="hero-inner">
            <div class="brand">
                <div class="brand-icon">œÉ</div>
                <h1 class="brand-name">Socratic</h1>
            </div>
            <p class="tagline">Let's get you set up in 30 seconds.</p>
        </div>
    </header>

    <section class="topic-section">
        <div class="topic-card" style="max-width: 540px; margin: 0 auto;">
            <h2>Enter Your Gemini API Key</h2>

            <div class="setup-trust-badges">
                <div class="trust-badge">
                    <span class="trust-icon">üîí</span>
                    <span>Stored <strong>only</strong> on your machine</span>
                </div>
                <div class="trust-badge">
                    <span class="trust-icon">üåê</span>
                    <span>Never sent to any server except Google</span>
                </div>
                <div class="trust-badge">
                    <span class="trust-icon">üí∏</span>
                    <span>Gemini API is <strong>free</strong> to use</span>
                </div>
            </div>

            <form id="setupForm" class="topic-form" style="margin-top: 24px;">
                <div class="input-group">
                    <input type="password" id="apiKeyInput" placeholder="Paste your Gemini API key here..." autocomplete="off" required>
                    <button type="submit" id="saveBtn" class="btn-primary">
                        <span class="btn-text">Save & Start</span>
                        <span class="btn-loading" style="display:none;">
                            <span class="spinner"></span>
                        </span>
                    </button>
                </div>
                <div style="margin-top: 8px; text-align: left;">
                    <label style="font-size: 0.8rem; color: var(--text-muted); cursor: pointer; display: flex; align-items: center; gap: 6px;">
                        <input type="checkbox" id="showKey" style="accent-color: var(--accent-primary);">
                        Show key
                    </label>
                </div>
                <p id="setupError" style="color: var(--danger); font-size: 0.85rem; margin-top: 12px; display: none;"></p>
            </form>

            <div class="setup-steps">
                <h3>How to get a free API key:</h3>
                <ol>
                    <li>Go to <a href="https://aistudio.google.com/apikey" target="_blank" rel="noopener">aistudio.google.com/apikey</a></li>
                    <li>Sign in with your Google account</li>
                    <li>Click <strong>"Create API key"</strong></li>
                    <li>Copy the key and paste it above</li>
                </ol>
            </div>

            <div class="setup-privacy">
                <h4>üõ°Ô∏è Privacy Promise</h4>
                <p>
                    Your API key is saved to a local <code>.env</code> file in this project's folder.
                    It is <strong>never uploaded, logged, or shared</strong>. Socratic runs entirely
                    on your machine ‚Äî the only external call is directly from your browser to Google's
                    Gemini API. You can delete the key at any time by editing the <code>.env</code> file.
                </p>
            </div>
        </div>
    </section>
</div>

<style>
    .setup-trust-badges {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-top: 20px;
        align-items: center;
    }
    .trust-badge {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.88rem;
        color: var(--text-secondary);
    }
    .trust-icon {
        font-size: 1.1rem;
    }
    .setup-steps {
        margin-top: 28px;
        text-align: left;
        padding: 20px 24px;
        background: var(--bg-secondary);
        border-radius: var(--radius-md);
        border: 1px solid var(--border-subtle);
    }
    .setup-steps h3 {
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    .setup-steps ol {
        padding-left: 20px;
        color: var(--text-primary);
        font-size: 0.9rem;
        line-height: 1.8;
    }
    .setup-steps a {
        color: var(--accent-primary);
        text-decoration: underline;
    }
    .setup-privacy {
        margin-top: 20px;
        padding: 16px 20px;
        background: var(--success-bg);
        border: 1px solid rgba(34, 197, 94, 0.15);
        border-radius: var(--radius-md);
        text-align: left;
    }
    .setup-privacy h4 {
        font-size: 0.85rem;
        color: var(--success);
        margin-bottom: 6px;
    }
    .setup-privacy p {
        font-size: 0.82rem;
        color: var(--text-secondary);
        line-height: 1.6;
    }
    .setup-privacy code {
        background: var(--bg-accent);
        padding: 1px 5px;
        border-radius: 3px;
        font-size: 0.8rem;
    }
</style>

<script>
    document.getElementById('showKey').addEventListener('change', function() {
        document.getElementById('apiKeyInput').type = this.checked ? 'text' : 'password';
    });

    document.getElementById('setupForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const key = document.getElementById('apiKeyInput').value.trim();
        const errEl = document.getElementById('setupError');
        const btn = document.getElementById('saveBtn');

        if (!key) return;

        errEl.style.display = 'none';
        btn.querySelector('.btn-text').style.display = 'none';
        btn.querySelector('.btn-loading').style.display = 'inline-flex';
        btn.disabled = true;

        try {
            const res = await fetch('/api/setup', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ api_key: key })
            });
            const data = await res.json();

            if (data.success) {
                window.location.href = '/';
            } else {
                errEl.textContent = data.error || 'Failed to save key. Please try again.';
                errEl.style.display = 'block';
            }
        } catch (err) {
            errEl.textContent = 'Network error. Please make sure the server is running.';
            errEl.style.display = 'block';
        } finally {
            btn.querySelector('.btn-text').style.display = 'inline';
            btn.querySelector('.btn-loading').style.display = 'none';
            btn.disabled = false;
        }
    });
</script>
{% endblock %}
